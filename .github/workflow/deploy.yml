name: Deploy to ECS with Blue/Green

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: khaleel-strapi-app
  ECS_CLUSTER: khaleel-strapi-cluster
  ECS_SERVICE: khaleel-strapi-service
  CONTAINER_NAME: khaleel-strapi-container
  S3_BUCKET: bucket-mku

jobs:
  terraform-apply:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: terraform init

    - name: Terraform Apply
      run: terraform apply -auto-approve

  build-and-push:
    needs: terraform-apply
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build Docker image
      run: |
        docker build -t ${{ env.ECR_REPOSITORY }}:${{ github.sha }} .

    - name: Tag Docker image
      run: |
        docker tag ${{ env.ECR_REPOSITORY }}:${{ github.sha }} \
          301782007642.dkr.ecr.ap-south-1.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
        docker tag ${{ env.ECR_REPOSITORY }}:${{ github.sha }} \
          301782007642.dkr.ecr.ap-south-1.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest

    - name: Push Docker image to ECR
      run: |
        docker push 301782007642.dkr.ecr.ap-south-1.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
        docker push 301782007642.dkr.ecr.ap-south-1.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest

    - name: Save image info
      run: |
        echo "IMAGE=301782007642.dkr.ecr.ap-south-1.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_ENV

  blue-green-deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Update task definition template
      id: update-task-def
      run: |
        # Replace IMAGE_PLACEHOLDER with actual image
        sed "s|IMAGE_PLACEHOLDER|${{ env.IMAGE }}|g" task-definition.json > updated-task-definition.json
        
        # Register new task definition
        aws ecs register-task-definition --cli-input-json file://updated-task-definition.json
        
        # Get new task definition ARN
        TASK_DEF_ARN=$(aws ecs describe-task-definitions \
          --task-definition khaleel-strapi-task \
          --query 'taskDefinitions[0].taskDefinitionArn' \
          --output text)
        
        echo "TASK_DEF_ARN=$TASK_DEF_ARN" >> $GITHUB_ENV

    - name: Get subnet and security group IDs
      id: get-ids
      run: |
        # Get subnet IDs
        SUBNETS=$(aws ec2 describe-subnets \
          --filters "Name=default-for-az,Values=true" \
          --query 'Subnets[:2].SubnetId' \
          --output json)
        
        # Get security group ID
        SG_ID=$(aws ec2 describe-security-groups \
          --group-names khaleel-ecs-sg \
          --query 'SecurityGroups[0].GroupId' \
          --output text)
        
        echo "SUBNETS=$SUBNETS" >> $GITHUB_ENV
        echo "SG_ID=$SG_ID" >> $GITHUB_ENV

    - name: Update AppSpec template
      id: update-appspec
      run: |
        # Replace placeholders in appspec
        sed "s|<TASK_DEFINITION>|${{ env.TASK_DEF_ARN }}|g" appspec.yml | \
        sed "s|\"<SUBNETS>\"|${{ env.SUBNETS }}|g" | \
        sed "s|\"<SECURITY_GROUPS>\"|[\"${{ env.SG_ID }}\"]|g" > appspec-final.yml
        
        cat appspec-final.yml

    - name: Upload deployment files to S3
      id: upload-s3
      run: |
        # Create timestamp for unique deployment
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        
        # Upload updated files to S3
        aws s3 cp updated-task-definition.json s3://${{ env.S3_BUCKET }}/deployments/$TIMESTAMP/task-definition.json
        aws s3 cp appspec-final.yml s3://${{ env.S3_BUCKET }}/deployments/$TIMESTAMP/appspec.yml
        
        echo "S3_KEY=deployments/$TIMESTAMP/appspec.yml" >> $GITHUB_ENV
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

    - name: Trigger CodeDeploy Blue/Green Deployment
      id: codedeploy
      run: |
        # Trigger CodeDeploy with S3 location
        DEPLOYMENT_ID=$(aws deploy create-deployment \
          --application-name khaleel-strapi-app \
          --deployment-group-name khaleel-strapi-dg \
          --revision '{
            "revisionType": "S3",
            "s3Location": {
              "bucket": "'${{ env.S3_BUCKET }}'",
              "key": "'${{ env.S3_KEY }}'",
              "bundleType": "YAML"
            }
          }' \
          --query 'deploymentId' \
          --output text)
        
        echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
        echo "Blue/Green deployment started with ID: $DEPLOYMENT_ID"

    - name: Monitor Blue/Green Deployment
      run: |
        echo "Monitoring Blue/Green deployment..."
        
        for i in {1..60}; do
          STATUS=$(aws deploy get-deployment \
            --deployment-id ${{ env.DEPLOYMENT_ID }} \
            --query 'deploymentInfo.status' \
            --output text)
          
          echo "Status ($i/60): $STATUS"
          
          if [ "$STATUS" = "Succeeded" ]; then
            echo "âœ… Blue/Green deployment successful!"
            
            # Get current target group
            ALB_DNS=$(aws elbv2 describe-load-balancers \
              --names khaleel-strapi-alb \
              --query 'LoadBalancers[0].DNSName' \
              --output text)
            
            echo "ðŸŒ Application is now live at: http://$ALB_DNS"
            exit 0
            
          elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Stopped" ]; then
            echo "âŒ Blue/Green deployment failed!"
            exit 1
          fi
          
          sleep 10
        done
        
        echo "â° Deployment timeout"
        exit 1

    - name: Rollback on Failure
      if: failure()
      run: |
        echo "ðŸ”„ Initiating rollback for Blue/Green deployment..."
        
        # Stop the failed deployment
        aws deploy stop-deployment --deployment-id ${{ env.DEPLOYMENT_ID }}
        
        # Get previous task definition ARN
        PREV_TASK=$(aws ecs describe-task-definitions \
          --task-definition khaleel-strapi-task \
          --query 'taskDefinitions[1].taskDefinitionArn' \
          --output text)
        
        if [ -n "$PREV_TASK" ]; then
          echo "Rolling back to previous task definition: $PREV_TASK"
          
          # Create rollback AppSpec
          cat > rollback-appspec.yml <<EOF
          version: 0.0
          Resources:
            - TargetService:
                Type: AWS::ECS::Service
                Properties:
                  TaskDefinition: "$PREV_TASK"
                  LoadBalancerInfo:
                    ContainerName: "khaleel-strapi-container"
                    ContainerPort: 1337
          EOF
          
          # Upload rollback AppSpec to S3
          aws s3 cp rollback-appspec.yml s3://${{ env.S3_BUCKET }}/rollback/appspec.yml
          
          # Trigger rollback deployment
          aws deploy create-deployment \
            --application-name khaleel-strapi-app \
            --deployment-group-name khaleel-strapi-dg \
            --revision '{
              "revisionType": "S3",
              "s3Location": {
                "bucket": "'${{ env.S3_BUCKET }}'",
                "key": "rollback/appspec.yml",
                "bundleType": "YAML"
              }
            }'
          
          echo "âœ… Rollback deployment triggered"
        else
          echo "âš ï¸ No previous version found for rollback"
        fi